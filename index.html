<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>SchemaScript</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  body { font-family: "Segoe UI", sans-serif; background: #ffe6f0; margin: 2rem; }
  textarea { width: 100%; height: 150px; font-family: monospace; padding: 10px; border-radius: 8px; border: 1px solid #d63384; background: #fff0f5; }
  input[type=file] { margin-top: 10px; margin-bottom: 10px; }
  button { margin-top: 10px; margin-right: 10px; padding: 8px 12px; border: none; border-radius: 8px; background: #e83e8c; color: white; cursor: pointer; font-weight: bold; }
  button:hover { background: #c2185b; }
  #schema { margin-top: 20px; background: #fff0f5; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow-x: auto; }
  .title { text-align: center; font-size: 1.8em; font-weight: bold; color: #d63384; margin-bottom: 1em; }
  .section { border-left: 4px solid #d63384; padding-left: 12px; margin-bottom: 1em; background: #fff0f5; border-radius: 8px; padding: 10px 15px; }
  .section > .header-name { font-weight: bold; font-size: 1.2em; color: #d63384; margin-bottom: 0.5em; }
  .paragraph { background: #fff; padding: 8px 10px; border-radius: 6px; border: 1px solid #ffc0d6; margin-left: 20px; margin-bottom: 0.5em; box-shadow: 1px 1px 3px rgba(214,51,132,0.2); white-space: pre-wrap; }
  .section img { max-width: 200px; margin: 5px 0 5px 20px; border-radius: 8px; border: 1px solid #ffc0d6; background: #fff0f5; }
  #imagePreview { display:flex; flex-wrap:wrap; margin-top:10px; }
  #imagePreview div { position:relative; margin-right:10px; margin-bottom:10px; }
  #imagePreview img { max-width:80px; border-radius:6px; border:1px solid #ffc0d6; }
  #imagePreview span { position:absolute; top:-5px; left:-5px; background:#d63384; color:white; font-size:12px; border-radius:50%; padding:2px 6px; }
</style>
</head>
<body>

<h1 style="color:#d63384;">SchemaScript</h1>
<textarea id="code" placeholder="Scrivi qui il tuo SchemaScript..."></textarea>
<br>
<input type="file" id="imageUpload" multiple accept="image/*">
<div id="imagePreview"></div>
<br>
<button onclick="generateSchema()">Genera Schema</button>
<button onclick="downloadPNG()">Scarica PNG</button>

<div id="schema"></div>

<script>
let images = [];

// Anteprima immagini
document.getElementById('imageUpload').addEventListener('change', function(event) {
  images = [];
  const preview = document.getElementById('imagePreview');
  preview.innerHTML = '';
  const files = Array.from(event.target.files);
  files.forEach((file) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      images.push(e.target.result);
      const div = document.createElement('div');
      const img = document.createElement('img');
      img.src = e.target.result;
      const span = document.createElement('span');
      span.textContent = images.length;
      div.appendChild(img);
      div.appendChild(span);
      preview.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
});

function normalizeKey(s) {
  if (s === "_") return "_";
  return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[\u2018\u2019\u201C\u201D]/g, "")
    .replace(/[^\w\s]/g, "")
    .toLowerCase()
    .trim();
}

function isTokenLine(trimmed) {
  if (!trimmed) return false;
  const tokens = ["TITOLO", "SEZIONE", "RAMO", "CON", "PARAGRAFO", "IMMAGINE"];
  for (const t of tokens) if (trimmed.startsWith(t)) return true;
  return false;
}

function parseSchemaScript(code) {
  const rawLines = code.split(/\r?\n/).map(l => l.replace(/\r$/, ""));
  const tokens = ["TITOLO", "SEZIONE", "RAMO", "CON", "PARAGRAFO", "IMMAGINE"];

  let i = 0;
  const result = { title: "", sections: [] };
  const nodesByKey = {};

  const registerNode = (keyRaw, node) => {
    const keyNorm = normalizeKey(keyRaw);
    nodesByKey[keyNorm] = node;
    nodesByKey[keyRaw] = node;
  };

  while (i < rawLines.length) {
    const raw = rawLines[i];
    const line = raw.trim();
    if (!line) { i++; continue; }

    if (line.startsWith(tokens[0])) {
      result.title = line.slice(tokens[0].length).trim();
      i++; continue;
    }

    if (line.startsWith(tokens[1])) {
      const valRaw = line.slice(tokens[1].length).trim();
      const display = (valRaw === "_") ? "" : valRaw;
      const node = { name: display, children: [] };
      result.sections.push(node);
      registerNode(valRaw, node);
      i++; continue;
    }

    if (line.startsWith(tokens[2])) {
      const afterRamo = line.slice(tokens[2].length).trim();
      const conMatch = afterRamo.match(/\bCON\b/);
      if (conMatch) {
        const conIndex = conMatch.index;
        const targetRaw = afterRamo.slice(0, conIndex).trim();
        const afterCon = afterRamo.slice(conIndex + 3).trim();

        const keyNorm = normalizeKey(targetRaw);
        const parentNode = nodesByKey[keyNorm] || nodesByKey[targetRaw] || (() => {
          const display = (targetRaw === "_") ? "" : targetRaw;
          const n = { name: display, children: [] };
          result.sections.push(n);
          registerNode(targetRaw, n);
          return n;
        })();

        if (afterCon.startsWith(tokens[4])) {
          let j = i + 1;
          const collected = [];
          while (j < rawLines.length) {
            const nextTrim = rawLines[j].trim();
            if (nextTrim === "") { collected.push(""); j++; continue; }
            if (isTokenLine(nextTrim)) break;
            collected.push(nextTrim);
            j++;
          }
          if (collected.length > 0) {
            parentNode.children.push({ type: "paragraph", text: collected.join("\n") });
            i = Math.max(i, j - 1);
          }
        }
        else if (afterCon.startsWith(tokens[1])) {
          let headerValRaw = afterCon.slice(tokens[1].length).trim();
          if (!headerValRaw && i + 1 < rawLines.length) {
            const next = rawLines[i + 1].trim();
            if (next !== "") { headerValRaw = next; i++; }
          }
          if (headerValRaw !== undefined) {
            const display = (headerValRaw === "_") ? "" : headerValRaw;
            const newNode = { name: display, children: [] };
            parentNode.children.push(newNode);
            registerNode(headerValRaw, newNode);
          }
        }
        else if (afterCon.startsWith(tokens[5])) {
          const num = parseInt(afterCon.slice(tokens[5].length).trim());
          if (!isNaN(num) && images[num - 1]) parentNode.children.push({ type: "image", src: images[num - 1] });
        }
        else if (afterCon) {
          parentNode.children.push({ type: "paragraph", text: "(" + afterCon + ")" });
        }
      }
      i++; continue;
    }

    if (line.startsWith(tokens[5])) {
      const num = parseInt(line.slice(tokens[5].length).trim());
      if (!isNaN(num) && images[num - 1]) {
        const lastSection = result.sections[result.sections.length - 1];
        if (lastSection) lastSection.children.push({ type: "image", src: images[num - 1] });
      }
      i++; continue;
    }

    const lastSection = result.sections[result.sections.length - 1];
    if (lastSection) lastSection.children.push({ type: "paragraph", text: line });
    i++;
  }

  return result;
}

function renderSection(section, container) {
  const div = document.createElement("div");
  div.className = "section";
  if (section.name && section.name.trim() !== "") {
    const header = document.createElement("div");
    header.className = "header-name";
    header.textContent = section.name;
    div.appendChild(header);
  }

  section.children.forEach(child => {
    if (child.type === "paragraph") {
      const p = document.createElement("div");
      p.className = "paragraph";
      p.textContent = child.text;
      div.appendChild(p);
    } else if (child.type === "image") {
      const img = document.createElement("img");
      img.src = child.src;
      div.appendChild(img);
    } else if (child.name !== undefined) {
      renderSection(child, div);
    }
  });

  container.appendChild(div);
}

function generateSchema() {
  const code = document.getElementById("code").value;
  const parsed = parseSchemaScript(code);
  const container = document.getElementById("schema");
  container.innerHTML = "";
  if (parsed.title) {
    const t = document.createElement("div");
    t.className = "title";
    t.textContent = parsed.title;
    container.appendChild(t);
  }
  parsed.sections.forEach(sec => renderSection(sec, container));
}

function downloadPNG() {
  const container = document.getElementById("schema");
  html2canvas(container).then(canvas => {
    const link = document.createElement("a");
    let filename = prompt("Inserisci il nome del file (senza estensione):", "schema");
    if (!filename) filename = "schema";
    link.download = `${filename}.png`;
    link.href = canvas.toDataURL();
    link.click();
  });
}
</script>

</body>
</html>
